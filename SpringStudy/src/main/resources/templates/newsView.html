<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${teamFullName} + ' ë‰´ìŠ¤'">íŒ€ ë‰´ìŠ¤</title>
    <link rel="stylesheet" href="/newsView.css">
    <link rel="icon" type="image/png" href="/dugout.png" />

    <!-- ìºì‹œ ë°©ì§€ ë©”íƒ€ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
</head>
<body onload="loadNewsFromThymeleaf()">

<div class="team-buttons">
    <a class="team-btn kbo" href="/news/view/KBO">KBO ë¦¬ê·¸</a>
    <a class="team-btn ssg" href="/news/view/SSG">SSG</a>
    <a class="team-btn lg" href="/news/view/LG">LG</a>
    <a class="team-btn doosan" href="/news/view/DOOSAN">ë‘ì‚°</a>
    <a class="team-btn lotte" href="/news/view/LOTTE">ë¡¯ë°</a>
    <a class="team-btn nc" href="/news/view/NC">NC</a>
    <a class="team-btn kia" href="/news/view/KIA">KIA</a>
    <a class="team-btn kiwoom" href="/news/view/KIWOOM">í‚¤ì›€</a>
    <a class="team-btn hanwha" href="/news/view/HANWHA">í•œí™”</a>
    <a class="team-btn kt" href="/news/view/KT">KT</a>
    <a class="team-btn samsung" href="/news/view/SAMSUNG">ì‚¼ì„±</a>
</div>

<h1 th:text="${teamFullName} + ' ë‰´ìŠ¤ ê¸°ì‚¬'">íŒ€ ë‰´ìŠ¤</h1>

<div class="news-cards" id="news-container"></div>
<div id="pagination" class="pagination"></div>

<script th:inline="javascript">
    let currentPage = 1;
    const display = 5;
    const team = /*[[${team}]]*/ 'KBO'; // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ê¼­ ë‚´ë ¤ì¤˜ì•¼ í•¨

    // ì¤‘ë³µ ì œê±° í•¨ìˆ˜ (ì œëª©+URL ê¸°ì¤€)
    function dedupeNews(list) {
        const seen = new Set();
        return list.filter(n => {
            const key = `${n.url || ''}||${n.title || ''}`.trim();
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
        });
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ UI ìƒì„±
    function renderPagination(totalPages) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('span');
            btn.classList.add('page-btn');
            if (i === currentPage) btn.classList.add('active');
            btn.innerText = i;
            btn.addEventListener('click', () => {
                currentPage = i;
                loadNews(i);
            });
            pagination.appendChild(btn);
        }
    }

    // ë‰´ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadNews(page = 1) {
        const container = document.getElementById('news-container');
        if (page === 1) container.innerHTML = '<p>ë¡œë”© ì¤‘...</p>';

        // ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒë¼ë¯¸í„° ì¶”ê°€
        const url = `/news/${encodeURIComponent(team)}?page=${page}&display=${display}&_=${Date.now()}`;

        try {
            const res = await fetch(url, {
                cache: 'no-store',
                headers: { 'Cache-Control': 'no-cache' }
            });
            const rawList = await res.json();

            // ì¤‘ë³µ ì œê±°
            const newsList = dedupeNews(rawList);

            if (newsList.length === 0 && page === 1) {
                container.innerHTML = '<p>ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                renderPagination(1);
                return;
            }

            if (page === 1) container.innerHTML = '';

            container.innerHTML = newsList.map(news => `
                <div class="news-card">
                    <h3><a href="${news.url}" target="_blank" rel="noopener">${news.title}</a></h3>
                    <p>${news.summary ? news.summary : ''}</p>
                    <div class="date">${news.pubDate ? news.pubDate : ''}</div>
                </div>
            `).join('');

            renderPagination(5); // ì´ í˜ì´ì§€ ìˆ˜ë¥¼ ì„œë²„ ì‘ë‹µ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì • ê°€ëŠ¥
        } catch (e) {
            container.innerHTML = '<p>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>';
        }
    }

    // bfcache ë³µê·€ ì‹œì—ë„ ì¬ë¡œë“œ
    window.addEventListener('pageshow', (ev) => {
        if (ev.persisted) loadNews(currentPage);
    });

    function loadNewsFromThymeleaf() {
        loadNews(1);
    }
</script>

<div class="back-btn">
    <a href="/dugout" class="btn">ğŸ  ë”ê·¸ì•„ì›ƒìœ¼ë¡œ ê°€ê¸°</a>
</div>

<footer>
    Â© 2025 ë”ê·¸ì•„ì›ƒ. â€œë‹¹ì‹ ì˜ ì† ì•ˆì— ìˆëŠ” ì•¼êµ¬ì¥, ì—¬ê¸°ëŠ” ë”ê·¸ì•„ì›ƒì…ë‹ˆë‹¤.â€
</footer>
</body>
</html>
